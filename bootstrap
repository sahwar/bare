#!/bin/sh

set -e

usage() {
  cat <<EOF
$0 -x <cross prefix> -r <rootfs prefix>

Example:

    $0 -x /tmp/xunil-cross -r /tmp/xunil-rootfs
EOF
  exit 1
}

reqs() {
  local b
  local missing

  for b in cc c++ make patch tar xz curl perl; do
    which $b >/dev/null 2>&1 || missing="$missing $b"
  done

  if [ "$missing" ]; then
    printf "need '%s'\n" $missing
    exit 1
  fi
}

cross() {
  local prefix=$CROSS_PREFIX/$TRIPLE

  if ! [ -e $prefix/$TRIPLE/usr ]; then
    mkdir -p $prefix/$TRIPLE
    ln -s . $prefix/$TRIPLE/usr
  fi

  if ! [ -x $prefix/bin/$TRIPLE-ar ]; then
    MK_TARGET=$TRIPLE \
    MK_PREFIX=$prefix \
    MK_CONFIGURE="--prefix=$prefix" \
    MK_DESTDIR=no \
      ./mk install bootstrap-0-binutils
  fi

  # Add cross binutils to front of PATH:
  PATH=$prefix/bin:$PATH

  if ! [ -x $prefix/bin/$TRIPLE-gcc ]; then
    ./mk extract bootstrap-0-gcc

    local dep dest
    for dep in gmp mpfr mpc; do
      ./mk extract $dep
      dest=$(./mk query bootstrap-0-gcc MK_SRC)/$dep
      [ -h $dest ] || ln -s $(./mk query $dep MK_SRC) $dest
    done

    MK_TARGET=$TRIPLE \
    MK_PREFIX=$prefix \
    MK_CONFIGURE="--prefix=$prefix" \
    MK_DESTDIR=no \
      ./mk install bootstrap-0-gcc
  fi

  if ! [ -e $prefix/$TRIPLE/include/linux/inotify.h ]; then
    MK_DESTDIR=$prefix \
    MK_PREFIX=$TRIPLE \
      ./mk install bootstrap-0-linux-headers
  fi

  if ! [ -e $prefix/$TRIPLE/include/stdio.h ]; then
    MK_PREFIX=$prefix/$TRIPLE \
    CROSS_COMPILE=$TRIPLE- \
    CC=$TRIPLE-gcc \
    MK_CONFIGURE="--prefix=$prefix/$TRIPLE" \
    MK_DESTDIR=no \
      ./mk install bootstrap-0-musl
  fi
}

rootfs() {
  :
}

while getopts "r:x:h" opt; do
  case $opt in
    x)
      CROSS_PREFIX=$OPTARG
      ;;
    r)
      ROOTFS_PREFIX=$OPTARG
      ;;
    h)
      usage
      ;;
  esac
done

[ "$CROSS_PREFIX" ] || usage
[ "$ROOTFS_PREFIX" ] || usage

TRIPLE=$(uname -m)-linux-musl

reqs
cross
rootfs
